{% extends "base_old.html" %}

{% block title %}Maintenance Calendar - GearGuard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='calendar.css') }}">
<style>
    .calendar-container {
        width: 100% !important;
        min-height: 600px !important;
        display: flex !important;
        flex-direction: column !important;
        background: white !important;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        position: relative;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .calendar-main {
        display: flex !important;
        gap: 20px;
        flex: 1;
        min-height: 500px !important;
        visibility: visible !important;
    }
    
    .calendar-grid-container {
        flex: 1;
        position: relative;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: white;
        min-height: 600px !important;
        visibility: visible !important;
    }
    
    .calendar-grid {
        display: grid !important;
        grid-template-columns: 80px repeat(7, 1fr) !important;
        min-width: 1000px;
        width: 100%;
        background: white;
        visibility: visible !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- Calendar Header -->
    <div class="calendar-header">
        <h1 class="calendar-title">Maintenance Calendar</h1>
        
        <!-- Navigation Controls -->
        <div class="calendar-controls">
            <button class="nav-btn" id="prevWeek" onclick="changeWeek(-1)">
                <span>‚Üê</span>
            </button>
            <button class="nav-btn" id="nextWeek" onclick="changeWeek(1)">
                <span>‚Üí</span>
            </button>
            <select class="view-select" id="viewSelect" onchange="changeView(this.value)">
                <option value="week" selected>Week</option>
                <option value="month">Month</option>
            </select>
            <button class="today-btn" onclick="goToToday()">Today</button>
            <div class="current-week" id="currentWeek">Loading...</div>
        </div>
    </div>

    <!-- Main Calendar Area -->
    <div class="calendar-main">
        <!-- Weekly Calendar Grid -->
        <div class="calendar-grid-container">
            <div class="calendar-grid" id="calendarGrid">
                <!-- Time column -->
                <div class="time-column">
                    {% for hour in range(24) %}
                        <div class="time-slot" data-time="{{ '%02d:00'|format(hour) }}">{{ '%02d:00'|format(hour) }}</div>
                    {% endfor %}
                </div>

                <!-- Days grid -->
                <div class="days-grid" id="daysGrid">
                    <!-- Days header -->
                    <div class="day-header">SUN</div>
                    <div class="day-header">MON</div>
                    <div class="day-header">TUE</div>
                    <div class="day-header">WED</div>
                    <div class="day-header">THU</div>
                    <div class="day-header">FRI</div>
                    <div class="day-header">SAT</div>
                    
                    <!-- Dates header (will be updated by JavaScript) -->
                    <div class="date-header" id="date-0">1</div>
                    <div class="date-header" id="date-1">2</div>
                    <div class="date-header" id="date-2">3</div>
                    <div class="date-header" id="date-3">4</div>
                    <div class="date-header" id="date-4">5</div>
                    <div class="date-header" id="date-5">6</div>
                    <div class="date-header" id="date-6">7</div>
                    
                    <!-- Time slots for each day -->
                    {% for hour in range(24) %}
                        {% for day in range(7) %}
                            <div class="time-cell" data-day="{{ day }}" data-hour="{{ hour }}" data-time="{{ '%02d:00'|format(hour) }}"></div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Current time indicator -->
            <div class="current-time-line" id="currentTimeLine"></div>
        </div>

        <!-- Mini Calendar Sidebar -->
        <div class="mini-calendar">
            <div class="mini-calendar-header">
                <button class="mini-nav-btn" onclick="changeMonth(-1)">‚Üê</button>
                <div class="mini-calendar-month" id="miniCalendarMonth">December 2025</div>
                <button class="mini-nav-btn" onclick="changeMonth(1)">‚Üí</button>
            </div>
            <div class="mini-calendar-grid">
                <div class="mini-day-header">S</div>
                <div class="mini-day-header">M</div>
                <div class="mini-day-header">T</div>
                <div class="mini-day-header">W</div>
                <div class="mini-day-header">T</div>
                <div class="mini-day-header">F</div>
                <div class="mini-day-header">S</div>
                <div id="miniCalendarDates"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Calendar data
    const scheduledRequests = {{ scheduled_requests | tojson }};
    const currentDate = '{{ current_date }}';
    const currentTime = '{{ current_time }}';
    
    console.log('=== CALENDAR DATA LOADED ===');
    console.log('Scheduled requests from server:', JSON.stringify(scheduledRequests, null, 2));
    console.log('Number of scheduled requests:', scheduledRequests ? scheduledRequests.length : 0);
    console.log('Current date:', currentDate);
    console.log('Current time:', currentTime);
    
    // Validate data
    if (!scheduledRequests || !Array.isArray(scheduledRequests)) {
        console.error('ERROR: scheduledRequests is not a valid array!', scheduledRequests);
    } else if (scheduledRequests.length === 0) {
        console.warn('WARNING: No scheduled requests found in database');
    } else {
        console.log('Scheduled request details:');
        scheduledRequests.forEach((req, idx) => {
            console.log(`  [${idx}] ID: ${req.id}, Subject: ${req.subject}, Date: ${req.scheduled_date}, Priority: ${req.priority}`);
        });
    }
    
    // Initialize current week start (Sunday of current week)
    // Note: getDay() returns 0 for Sunday, 1 for Monday, etc.
    let currentWeekStart = new Date();
    const dayOfWeek = currentWeekStart.getDay(); // 0 = Sunday, 1 = Monday, etc.
    currentWeekStart.setDate(currentWeekStart.getDate() - dayOfWeek);
    currentWeekStart.setHours(0, 0, 0, 0);
    
    console.log('Initial week start (Sunday):', currentWeekStart.toISOString().split('T')[0]);
    
    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== CALENDAR INITIALIZING ===');
        console.log('Scheduled requests:', scheduledRequests);
        console.log('Current week start:', currentWeekStart);
        console.log('Scheduled requests count:', scheduledRequests ? scheduledRequests.length : 0);
        
        // Force visibility
        const container = document.querySelector('.calendar-container');
        if (container) {
            container.style.display = 'flex';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            console.log('Calendar container found and made visible');
        } else {
            console.error('Calendar container not found!');
        }
        
        const grid = document.querySelector('.calendar-grid');
        if (grid) {
            grid.style.display = 'grid';
            grid.style.visibility = 'visible';
            console.log('Calendar grid found and made visible');
        } else {
            console.error('Calendar grid not found!');
        }
        
        try {
            updateCalendar();
            updateMiniCalendar();
            updateCurrentTimeLine();
            
            // Check if there are scheduled requests and if any are in the current week
            if (scheduledRequests && scheduledRequests.length > 0) {
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + i);
                    weekDates.push(date.toISOString().split('T')[0]);
                }
                
                const requestsInWeek = scheduledRequests.filter(req => {
                    if (!req.scheduled_date) return false;
                    const reqDate = req.scheduled_date.split(' ')[0].split('T')[0];
                    return weekDates.includes(reqDate);
                });
                
                if (requestsInWeek.length === 0) {
                    // Find the earliest scheduled date
                    const earliestDate = scheduledRequests
                        .map(r => r.scheduled_date ? r.scheduled_date.split(' ')[0].split('T')[0] : null)
                        .filter(d => d)
                        .sort()[0];
                    
                    if (earliestDate) {
                        const scheduledDateObj = new Date(earliestDate + 'T00:00:00');
                        const weekStartOfScheduled = new Date(scheduledDateObj);
                        weekStartOfScheduled.setDate(scheduledDateObj.getDate() - scheduledDateObj.getDay());
                        weekStartOfScheduled.setHours(0, 0, 0, 0);
                        
                        console.warn(`‚ö† No scheduled requests in current week (${weekDates[0]} to ${weekDates[6]})`);
                        console.warn(`   Scheduled requests are on: ${scheduledRequests.map(r => r.scheduled_date ? r.scheduled_date.split(' ')[0] : 'N/A').join(', ')}`);
                        console.info(`üí° Auto-navigating to week with scheduled requests: ${weekStartOfScheduled.toISOString().split('T')[0]}`);
                        
                        // Auto-navigate to the week with scheduled requests
                        currentWeekStart = weekStartOfScheduled;
                        updateCalendar();
                        updateMiniCalendar();
                        
                        // Render after navigation
                        setTimeout(() => {
                            renderScheduledRequests();
                        }, 150);
                        return; // Exit early since we've navigated and will render
                    }
                } else {
                    console.log(`‚úì Found ${requestsInWeek.length} scheduled request(s) in current week`);
                }
            }
            
            // Small delay to ensure DOM is fully ready
            setTimeout(() => {
                renderScheduledRequests();
            }, 100);
            
            // Update time line every minute
            setInterval(updateCurrentTimeLine, 60000);
            
            console.log('Calendar initialized successfully');
        } catch (error) {
            console.error('Error initializing calendar:', error);
            console.error('Error stack:', error.stack);
            alert('Error initializing calendar: ' + error.message);
        }
    });
    
    function updateCalendar() {
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        
        console.log('Updating calendar for week starting:', currentWeekStart.toISOString().split('T')[0]);
        
        // Update date headers
        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            const dateHeader = document.getElementById(`date-${i}`);
            if (dateHeader) {
                const dateStr = date.toISOString().split('T')[0];
                dateHeader.textContent = date.getDate();
                dateHeader.setAttribute('data-date', dateStr);
                
                console.log(`  Date ${i}: ${dateStr} (${date.getDate()})`);
                
                // Highlight today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);
                if (date.getTime() === today.getTime()) {
                    dateHeader.classList.add('today');
                } else {
                    dateHeader.classList.remove('today');
                }
            }
        }
        
        // Update week display
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        const month = months[currentWeekStart.getMonth()];
        const year = currentWeekStart.getFullYear();
        const weekNumber = getWeekNumber(currentWeekStart);
        const weekDisplay = document.getElementById('currentWeek');
        if (weekDisplay) {
            weekDisplay.textContent = `${month} ${year} Week ${weekNumber}`;
        }
    }
    
    function updateMiniCalendar() {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        const today = new Date();
        const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        
        const monthDisplay = document.getElementById('miniCalendarMonth');
        if (monthDisplay) {
            monthDisplay.textContent = `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        }
        
        const firstDay = currentMonth.getDay();
        const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
        
        let calendarHTML = '';
        
        // Empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            calendarHTML += '<div class="mini-date-cell empty"></div>';
        }
        
        // Date cells
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = day === today.getDate() && currentMonth.getMonth() === today.getMonth() && currentMonth.getFullYear() === today.getFullYear();
            const isInWeek = isDateInCurrentWeek(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day));
            
            calendarHTML += `<div class="mini-date-cell ${isToday ? 'today' : ''} ${isInWeek ? 'in-week' : ''}" 
                             data-date="${dateStr}" onclick="selectDate('${dateStr}')">${day}</div>`;
        }
        
        const datesContainer = document.getElementById('miniCalendarDates');
        if (datesContainer) {
            datesContainer.innerHTML = calendarHTML;
        }
    }
    
    function isDateInCurrentWeek(date) {
        const weekStart = new Date(currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        return date >= weekStart && date <= weekEnd;
    }
    
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    function changeWeek(direction) {
        currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
        console.log('Week changed to:', currentWeekStart.toISOString().split('T')[0]);
        updateCalendar();
        updateMiniCalendar();
        // Clear and re-render events for the new week
        setTimeout(() => {
            renderScheduledRequests();
        }, 50);
    }
    
    function goToToday() {
        const today = new Date();
        currentWeekStart = new Date(today);
        currentWeekStart.setDate(today.getDate() - today.getDay());
        currentWeekStart.setHours(0, 0, 0, 0);
        console.log('Navigated to today, week start:', currentWeekStart.toISOString().split('T')[0]);
        updateCalendar();
        updateMiniCalendar();
        setTimeout(() => {
            renderScheduledRequests();
        }, 50);
    }
    
    function changeView(view) {
        // For now, only week view is implemented
        if (view === 'month') {
            alert('Month view coming soon!');
        }
    }
    
    function changeMonth(direction) {
        // Update mini calendar month
        updateMiniCalendar();
    }
    
    function selectDate(dateStr) {
        const date = new Date(dateStr);
        currentWeekStart = new Date(date);
        currentWeekStart.setDate(date.getDate() - date.getDay());
        currentWeekStart.setHours(0, 0, 0, 0);
        updateCalendar();
        updateMiniCalendar();
        renderScheduledRequests();
    }
    
    function updateCurrentTimeLine() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        
        // Only show if current day is in the visible week
        const weekStartDate = new Date(currentWeekStart);
        weekStartDate.setHours(0, 0, 0, 0);
        const weekEndDate = new Date(weekStartDate);
        weekEndDate.setDate(weekEndDate.getDate() + 6);
        weekEndDate.setHours(23, 59, 59, 999);
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const timeLine = document.getElementById('currentTimeLine');
        if (today >= weekStartDate && today <= weekEndDate) {
            const dayIndex = Math.floor((today - weekStartDate) / (1000 * 60 * 60 * 24));
            
            if (timeLine) {
                // Calculate position: 90px (headers) + (hour * 60px) + (minute * 1px)
                const topPosition = 90 + (currentHour * 60) + currentMinute;
                
                timeLine.style.display = 'block';
                timeLine.style.top = `${topPosition}px`;
                timeLine.style.left = `${80 + (dayIndex * 14.28)}%`;
                timeLine.style.width = '14.28%';
            }
        } else {
            if (timeLine) {
                timeLine.style.display = 'none';
            }
        }
    }
    
    function renderScheduledRequests() {
        // Clear existing events
        document.querySelectorAll('.calendar-event').forEach(el => el.remove());
        
        console.log('=== RENDERING SCHEDULED REQUESTS ===');
        console.log('Scheduled requests array:', scheduledRequests);
        console.log('Type:', typeof scheduledRequests);
        console.log('Is array:', Array.isArray(scheduledRequests));
        console.log('Length:', scheduledRequests ? scheduledRequests.length : 'null/undefined');
        
        // Check if scheduledRequests is valid
        if (!scheduledRequests || !Array.isArray(scheduledRequests)) {
            console.error('scheduledRequests is not a valid array!', scheduledRequests);
            return;
        }
        
        if (scheduledRequests.length === 0) {
            console.warn('No scheduled requests to display');
            return;
        }
        
        // Get week dates (YYYY-MM-DD format)
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            weekDates.push(dateStr);
        }
        
        console.log('Week dates for matching:', weekDates);
        console.log('Current week start:', currentWeekStart.toISOString().split('T')[0]);
        console.log('Current week start:', currentWeekStart);
        
        // Render scheduled requests
        scheduledRequests.forEach((request, index) => {
            console.log(`Processing request ${index + 1}/${scheduledRequests.length}:`, request);
            if (request.scheduled_date) {
                let scheduledDate = request.scheduled_date;
                let scheduledTime = null;
                
                // Parse date and time from scheduled_date
                // Handle formats: YYYY-MM-DD, YYYY-MM-DD HH:MM:SS, YYYY-MM-DDTHH:MM:SS
                if (scheduledDate.includes(' ')) {
                    const parts = scheduledDate.split(' ');
                    scheduledDate = parts[0];
                    if (parts.length > 1) {
                        scheduledTime = parts[1];
                    }
                } else if (scheduledDate.includes('T')) {
                    const parts = scheduledDate.split('T');
                    scheduledDate = parts[0];
                    if (parts.length > 1) {
                        scheduledTime = parts[1].split('.')[0]; // Remove milliseconds if present
                    }
                }
                
                // Check if this date is in the current week
                // Normalize dates for comparison (remove time component)
                const normalizedScheduledDate = scheduledDate.split(' ')[0].split('T')[0];
                const dayIndex = weekDates.indexOf(normalizedScheduledDate);
                
                console.log(`  Checking date: ${scheduledDate} -> normalized: ${normalizedScheduledDate}`);
                console.log(`  Day index: ${dayIndex}, weekDates: ${weekDates.join(', ')}`);
                
                    if (dayIndex !== -1 && dayIndex >= 0 && dayIndex < 7) {
                    console.log(`  ‚úì Date ${normalizedScheduledDate} is in current week (day ${dayIndex})`);
                    // Parse time from scheduled_date
                    let hour = 9; // Default to 9 AM
                    let minute = 0;
                    
                    if (scheduledTime) {
                        // Parse HH:MM or HH:MM:SS - handle both 1-digit and 2-digit hours
                        const timeMatch = scheduledTime.match(/(\d{1,2}):(\d{2})/);
                        if (timeMatch) {
                            hour = parseInt(timeMatch[1], 10);
                            minute = parseInt(timeMatch[2], 10);
                            console.log(`  Parsed time: ${hour}:${minute} from "${scheduledTime}"`);
                        } else {
                            console.warn(`  Could not parse time from "${scheduledTime}", using default`);
                        }
                    } else {
                        console.log(`  No time component found, using default: ${hour}:${minute}`);
                    }
                    
                    // Ensure hour is valid (0-23)
                    if (isNaN(hour) || hour < 0 || hour > 23) {
                        console.warn(`  Invalid hour ${hour}, defaulting to 9`);
                        hour = 9;
                    }
                    if (isNaN(minute) || minute < 0 || minute > 59) {
                        minute = 0;
                    }
                    
                    console.log(`Rendering request ${request.id}: Date=${scheduledDate}, Day=${dayIndex}, Time=${hour}:${minute}`);
                    
                    // Find the time cell for this day and hour
                    const cellSelector = `.time-cell[data-day="${dayIndex}"][data-hour="${hour}"]`;
                    const cell = document.querySelector(cellSelector);
                    
                    console.log(`  Looking for cell: ${cellSelector}`);
                    console.log(`  Cell found:`, cell ? 'YES' : 'NO');
                    
                    if (!cell) {
                        // Try to find any cell to debug
                        const allCells = document.querySelectorAll('.time-cell');
                        console.error(`  ‚úó Cell not found! Total cells in DOM: ${allCells.length}`);
                        if (allCells.length > 0) {
                            const sampleCell = allCells[0];
                            console.error(`  Sample cell attributes:`, {
                                'data-day': sampleCell.getAttribute('data-day'),
                                'data-hour': sampleCell.getAttribute('data-hour'),
                                'data-time': sampleCell.getAttribute('data-time')
                            });
                        }
                    }
                    
                    if (cell) {
                        const event = document.createElement('div');
                        event.className = 'calendar-event';
                        event.style.backgroundColor = getPriorityColor(request.priority);
                        // Position event at the top of the hour cell, adjusted by minutes
                        // Position event: top offset based on minutes within the hour (0-60px)
                        const topOffset = Math.round((minute / 60) * 60);
                        event.style.top = `${topOffset}px`;
                        event.style.height = '50px';
                        event.style.minHeight = '50px';
                        event.style.maxHeight = '50px';
                        event.style.padding = '4px 6px';
                        event.style.borderRadius = '4px';
                        event.style.cursor = 'pointer';
                        event.style.zIndex = '100';
                        event.style.position = 'absolute';
                        event.style.width = 'calc(100% - 4px)';
                        event.style.left = '2px';
                        event.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                        event.style.color = 'white';
                        event.style.fontSize = '0.75rem';
                        event.style.lineHeight = '1.3';
                        event.style.overflow = 'hidden';
                        event.style.display = 'block';
                        event.style.visibility = 'visible';
                        event.style.opacity = '1';
                        event.setAttribute('data-request-id', request.id);
                        event.setAttribute('data-hour', hour);
                        event.setAttribute('data-minute', minute);
                        
                        console.log(`  Event positioning: hour=${hour}, minute=${minute}, top=${topOffset}px`);
                        // Always show time since we're using created_at time when scheduled_date has no time
                        const showTime = true;
                        
                        event.innerHTML = `
                            <div class="event-title" style="font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(request.subject || 'Maintenance')}</div>
                            <div class="event-time" style="font-size: 0.7rem; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(request.technician || 'Unassigned')}</div>
                            ${showTime ? `<div class="event-time" style="font-size: 0.65rem; opacity: 0.8;">${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}</div>` : ''}
                        `;
                        event.onclick = () => viewRequestDetails(request.id);
                        
                        // Ensure cell is positioned relatively
                        const cellStyle = getComputedStyle(cell);
                        if (cellStyle.position === 'static') {
                            cell.style.position = 'relative';
                            console.log(`  Changed cell position from static to relative`);
                        }
                        
                        // Ensure cell has proper dimensions
                        cell.style.minHeight = '60px';
                        cell.style.height = '60px';
                        cell.style.overflow = 'visible';
                        
                        cell.appendChild(event);
                        console.log(`‚úì Event added to cell for day ${dayIndex}, hour ${hour}`);
                        console.log(`  Event details:`, {
                            id: request.id,
                            subject: request.subject,
                            backgroundColor: event.style.backgroundColor,
                            position: event.style.position,
                            top: event.style.top,
                            width: event.style.width,
                            zIndex: event.style.zIndex,
                            cellPosition: cellStyle.position,
                            cellHeight: cellStyle.height
                        });
                        
                        // Force a reflow to ensure visibility
                        event.offsetHeight;
                    } else {
                        console.error(`‚úó Cell not found for day ${dayIndex}, hour ${hour}`);
                        console.error(`  Selector used: ${cellSelector}`);
                        // Try to find all cells to debug
                        const allCells = document.querySelectorAll('.time-cell');
                        console.error(`  Total time cells found: ${allCells.length}`);
                        if (allCells.length > 0) {
                            console.error(`  First cell example:`, allCells[0]);
                            console.error(`  First cell data-day:`, allCells[0].getAttribute('data-day'));
                            console.error(`  First cell data-hour:`, allCells[0].getAttribute('data-hour'));
                        }
                    }
                } else {
                    console.log(`Request ${request.id} date ${scheduledDate} is not in current week (week dates: ${weekDates.join(', ')})`);
                }
            } else {
                console.warn(`Request ${request.id} has no scheduled_date:`, request);
            }
        });
        
        const totalEvents = document.querySelectorAll('.calendar-event').length;
        console.log(`=== RENDERING COMPLETE. Total events rendered: ${totalEvents} ===`);
        
        // Show summary of what was found
        if (totalEvents === 0) {
            if (scheduledRequests.length === 0) {
                console.warn('‚ö† No scheduled requests found in database');
            } else {
                console.warn(`‚ö† ${scheduledRequests.length} scheduled requests exist, but none match current week`);
                console.warn('   Scheduled dates:', scheduledRequests.map(r => r.scheduled_date).join(', '));
                console.warn('   Current week:', weekDates.join(' to '));
                console.warn('   Try navigating to the week containing the scheduled dates');
            }
        } else {
            console.log(`‚úì Successfully rendered ${totalEvents} event(s)`);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function getPriorityColor(priority) {
        const colors = {
            'Critical': '#e74c3c',
            'High': '#e67e22',
            'Medium': '#f39c12',
            'Low': '#3498db'
        };
        return colors[priority] || '#667eea';
    }
    
    function viewRequestDetails(requestId) {
        // Fetch and show request details in a modal
        fetch(`/view-request/${requestId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const request = data.request;
                    alert(`Request Details:\n\nSubject: ${request.subject}\nEmployee: ${request.employee}\nStatus: ${request.status}\nPriority: ${request.priority}\nScheduled: ${request.scheduled_date || 'Not scheduled'}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading request details');
            });
    }
</script>
{% endblock %}
